# AI日记App开发文档

本文档详细阐述了AI日记App的开发方案，涵盖了从核心功能定义到代码逻辑示例的各个方面，旨在为开发团队提供全面的指导。

已完成对参考应用 nian 的分析，并结合您的AI功能需求，初步整理了AI日记App的核心功能清单。接下来，我将开始设计应用的整体架构和数据流向。

# AI日记App核心功能需求

## 一、标准日记功能 (参考 "nian" 及通用日记应用):

1.  **用户认证与管理:**
    *   注册 (邮箱/密码，可选社交登录)。
    *   登录与登出。
    *   密码找回。
    *   用户个人资料管理 (头像、昵称等)。
2.  **日记条目创建与管理:**
    *   创建带标题和富文本内容的新日记条目。支持多种日记类型 (`diary_type`)，例如标准文本、感恩日记、梦境记录、AI辅助反思等。
    *   富文本编辑器: 支持加粗、斜体、下划线、列表 (项目符号、数字编号)、标题、引用块、代码块、超链接等。
    *   媒体附件: 图片、音频记录 (用于语音笔记/听写)、短视频片段 (可选)。附件可以有特定用途 (`attachment_purpose`)，如内联内容、日记封面 (`cover_image_attachment_id`)。
    *   条目日期和时间戳 (自动记录，支持手动调整)。
    *   条目心情跟踪/标记 (例如：开心、难过、高效，或更细化的情感标签)。
    *   自定义标签，用于组织条目。
    *   个性化条目外观：支持设置封面图片、背景样式 (`background_style_json`，如纯色、背景图片、渐变)。
    *   特定条目配置：支持针对条目的自定义设置 (`custom_settings_json`)，例如AI交互参数、显示选项等。
    *   排序与置顶：支持条目置顶 (`is_pinned`) 和自定义排序 (`sort_index`)。
    *   搜索功能: 按关键词、日期范围、标签、心情、日记类型搜索。
    *   条目查看方式: 日历视图、时间轴视图、列表视图。
    *   编辑和删除日记条目。
    *   草稿自动保存功能。
3.  **清单管理 (待办事项/清单):**
    *   创建带标题的新清单。支持多种清单类型 (`list_type`)，例如标准待办、目标追踪器、普通清单。
    *   向清单中添加项目。
    *   标记项目为完成/未完成。
    *   重新排序清单项目。
    *   为清单项目设置截止日期/提醒 (可选，可作为后续版本功能)。
    *   目标追踪：对于特定类型的清单，支持设置目标进度 (`target_progress`)、当前进度 (`current_progress`) 和进度单位 (`progress_unit`)。
    *   特定清单配置：支持针对清单的自定义设置 (`custom_settings_json`)。
    *   清单分类或标记。
4.  **组织与导航:**
    *   笔记本/文件夹: 允许用户将日记或清单分组到不同的笔记本或文件夹 (例如："个人日记"、"工作笔记"、"灵感记录")。
    *   时间轴/日历视图: 便捷浏览历史条目。
    *   强大的全局搜索和筛选功能。
5.  **个性化与设置:**
    *   主题选择 (浅色/深色模式，强调色)。
    *   阅读和写作的字体定制。
    *   通知偏好设置 (例如：写作提醒)。
    *   数据备份与恢复选项 (例如：导出为PDF/TXT，云同步)。
    *   隐私设置 (例如：应用密码锁)。

## 二、AI驱动功能 (根据用户需求):

1.  **AI辅助写作:**
    *   **内容生成/建议:**
        *   基于上下文的句子补全/建议 (可利用日记条目的 `custom_settings_json` 中的AI参数)。
        *   基于关键词或起始句的段落生成 (可利用日记条目的 `custom_settings_json` 中的AI参数)。
        *   日记主题的灵感生成 (例如："今天我该写些什么？")。
        *   长篇条目的内容摘要。
    *   **内容改进:**
        *   语法和拼写纠错。
        *   风格和语气建议 (例如：使其更具反思性、更正式) (可利用日记条目的 `custom_settings_json` 中的AI参数)。
        *   词汇润色与增强。
    *   **模板化写作:** AI辅助填写特定类型条目的预定义模板 (例如：感恩日记、梦境记录、每日反思)。
2.  **AI对话式日记/清单创建:**
    *   **对话界面:** 用户可以通过与AI"交谈"来记录日记条目或创建清单。
        *   示例：用户说："AI，为今天新建一篇日记。我去了公园，感觉很放松。"
        *   示例：用户说："AI，创建一个名为'购物单'的待办事项清单，并添加牛奶、鸡蛋和面包。"
    *   **追问引导:** AI可以提出引导性问题，以获取更多日记或清单的细节。
        *   示例：AI："能详细说说在公园里是什么让您感到放松吗？"
    *   **语音转文字听写:** 将口述语言无缝转换为文本，用于日记条目或清单项目。
3.  **AI驱动的洞察与反思 (高级功能):**
    *   **情绪分析:** 分析文本以识别一段时间内的主要情绪或情感状态。
    *   **主题检测:** 识别日记条目中反复出现的主题或议题。
    *   **个性化提示:** 基于过往条目或检测到的模式，推荐反思性问题。
    *   **情绪趋势可视化:** 展示数周或数月内情绪/情感的变化情况。
4.  **多API模型选择:**
    *   **用户可选的AI模型:** 允许用户通过API集成选择不同的AI模型/提供商 (例如：OpenAI GPT系列、Anthropic Claude、Google Gemini，或可行的开源模型)。
    *   **配置面板:** 设置区域，用户可以在此输入API密钥 (如果模型提供商要求) 或从应用提供的预配置免费/付费层级中选择。
    *   **模型特定能力:** UI应能适应所选模型的特性，或告知用户其优缺点及特定功能。

## 三、通用应用功能:

1.  **跨平台同步 (可选但推荐):** 在多个设备 (iOS、Android、Web) 间同步数据。
2.  **离线访问:** 即使没有网络连接也能创建和查看条目，联网后自动同步。
3.  **导出选项:** 以多种格式 (PDF、TXT、Markdown) 导出日记/清单。
4.  **安全与隐私:**
    *   敏感数据的端到端加密 (尤其在启用云同步时)。
    *   本地数据加密。
    *   清晰的关于AI数据使用的隐私政策。
5.  **用户界面 (UI) 与用户体验 (UX):**
    *   简洁、直观且美观的设计。
    *   便捷的导航。
    *   针对不同屏幕尺寸的响应式设计。

## 四、人脉关系管理与情商辅助功能

### 1. 核心功能 (Features)：

*   **人物档案记录 (Profile Recording)：**
    *   记录朋友、亲人等联系人的基础信息，如：兴趣爱好、口味、重要日期（生日等）。**AI辅助：可从日记、对话记录（用户授权后）中智能提取并建议待记录的人物信息。**
    *   记录与人物相关的往来事情，如：重要对话摘要、发生的事件、承诺、共同经历、金钱往来等。**AI辅助：可对长对话进行摘要，自动识别事件、承诺等关键信息，并关联到对应人物。**
    *   结构化、分类记录，而非简单的备忘录。**AI辅助：根据记录内容自动推荐标签或分类。**
*   **智能提醒 (Intelligent Reminders)：**
    *   基于记录的内容（如纪念日、重要事件），设置关键节点的提醒，避免遗忘。**AI辅助：分析互动模式和记录内容，预测潜在的重要跟进事项或联系时机，并提供更智能化的提醒（例如，"您与[某人]上次深入交流已是两周前，是否考虑问候一下？"）。**
*   **人际关系分析与建议 (Relationship Analysis & Suggestions)：**
    *   亲密度分析： **AI基于互动频率、沟通情感倾向（从记录文本中分析）、共同经历的积极性、重要事件的参与度等多维度数据，综合量化关系亲密度。**
    *   印象分析： **AI分析用户在日记中描述人物的用词、语气及情感色彩，以及与该人物相关的事件记录，辅助洞察用户对该人物的潜在印象，或该人物可能给用户留下的印象。**
    *   关系维护建议： **AI基于亲密度分析、印象分析及用户设定的关系目标，生成个性化的关系维护行动建议和沟通策略（例如，建议联系某位久未联系的朋友，或针对特定纪念日提出庆祝或祝福建议，甚至提供沟通开场白参考）。**
*   **数据可视化与呈现 (Data Visualization & Presentation)：**
    *   关系网构建： 清晰展示用户的社交网络图谱。**AI辅助：识别关系网中的关键节点、连接强度，辅助理解社交结构。**
    *   足迹地图： 记录与每个人互动轨迹，见证关系演变。
    *   时间线记录： 生成与朋友交往的周期时间线，以及个人整体的人际交往时间线。
    *   朋友档案卡片： 生成精致的、可分享的朋友档案卡片。
*   **组织与管理 (Organization & Management)：**
    *   通过标签、分类等方式对朋友和社交圈子进行划分和管理。
*   **情商辅助 (EQ Assistance)：**
    *   通过记录和提醒，帮助用户表现得更细心、周到，从而在他人看来更具情商。**AI辅助：根据记录的互动和用户反馈，潜移默化地提示和引导用户采纳更优的沟通方式和人际处理技巧。**
    *   辅助用户逐步养成更舒适的情商思维和人际交往习惯。

### 2. 主要需求/产品目标 (Requirements/Product Goals)：

*   **全面的信息记录：**
    *   能够记录朋友（及其他联系人）的基础信息（爱好、口味等）。
    *   能够结构化、分类记录与朋友间的往来和重要事件（重要对话、事件、会面、金钱往来等），超越简单备忘。
*   **高效的组织管理：**
    *   支持通过标签、分类等方式对朋友和圈子进行有效划分。
*   **及时的互动提醒：**
    *   能够在与朋友的往来中，针对关键节点进行提醒。
*   **深度的关系洞察：**
    *   能够对记录的数据进行分析，并提供与朋友交往的建议。
    *   能够基于数据进行客观分析，如亲密度、他人印象等。
*   **清晰的关系呈现：**
    *   能够根据记录数据，形成个人与朋友的关系记录，包括关系网、圈子记录、与朋友的完整交往时间线，以及个人整体的交往时间线。
    *   能够生成可分享的、精致的朋友档案卡片。
*   **提升用户情商与关系质量：**
    *   帮助用户记住重要细节，从而被视为靠谱、有情商。
    *   将情商提升的方法融入工具，辅助用户处理人际关系。
    *   成为用户处理人际关系的得力助手，让用户在复杂人际交往中游刃有余。
*   **生活记录工具：**
    *   也可作为以"人"为维度的生活记录工具，长期记录可形成与某人的故事集、回忆录。





# AI日记App架构与数据流设计

## 一、整体架构

AI日记App将采用典型的客户端-服务器架构 (Client-Server Architecture)，并集成第三方AI服务。主要组件包括：

1.  **客户端 (Frontend):**
    *   **平台:** 移动应用 (iOS, Android)，可考虑Web应用作为补充。
    *   **技术栈示例:** React Native / Flutter (跨平台移动开发)，或原生开发 (Swift/Kotlin)，Vue.js / React (Web)。
    *   **职责:**
        *   用户界面 (UI) 渲染与用户体验 (UX) 交互。
        *   本地数据缓存与离线支持 (例如：SQLite, Realm)。
        *   设备功能调用 (例如：相机、麦克风用于媒体附件和语音输入)。
        *   向后端API发起请求。
        *   管理用户会话和本地状态。

2.  **后端 (Backend):**
    *   **技术栈示例:** Python (Flask/Django), Node.js (Express.js), Java (Spring Boot), Ruby on Rails。
    *   **职责:**
        *   提供API接口 (RESTful 或 GraphQL) 供客户端调用。
        *   用户认证与授权 (例如：JWT, OAuth2)。
        *   业务逻辑处理 (日记、清单、用户管理等)。
        *   **新增：人脉关系管理逻辑 (联系人档案、互动记录、提醒、关系洞察、情商辅助等)。**
        *   与数据库进行数据交互 (CRUD操作)。
        *   与第三方AI模型API进行集成和通信。
        *   管理AI模型API密钥 (安全存储，例如使用Vault或环境变量)。
        *   处理文件上传 (例如：图片、音频到云存储服务)。
    *   **(可考虑将不同业务逻辑拆分为微服务或明确的服务模块，例如：用户服务、日记服务、清单服务、人脉关系服务、AI集成服务等)**

3.  **数据库 (Database):**
    *   **类型示例:** 关系型数据库 (PostgreSQL, MySQL) 或 NoSQL数据库 (MongoDB)。考虑到用户、日记、清单之间的关系以及富文本内容的结构化存储需求，关系型数据库通常是较好的起点，但对于非结构化AI交互记录，NoSQL也可能适用。
    *   **职责:**
        *   持久化存储用户信息、日记条目 (包括不同类型的日记 `diary_type`、封面 `cover_image_attachment_id`、背景 `background_style_json`、自定义设置 `custom_settings_json`、排序索引 `sort_index`)、清单 (包括不同类型的清单 `list_type`、进度相关字段、自定义设置 `custom_settings_json`)、标签、心情、媒体附件 (及其用途 `attachment_purpose`)、用户偏好设置 (`app_settings`)、AI模型配置 (`ai_models`, `user_ai_model_configs`)、AI交互记录 (`ai_interaction_logs`)等。
        *   确保数据一致性、完整性和安全性。

4.  **第三方AI服务 (External AI Services):**
    *   **提供商示例:** OpenAI (GPT系列), Anthropic (Claude系列), Google (Gemini系列), 以及其他可接入的开源或商业模型API。
    *   **职责:**
        *   接收来自后端的文本输入或指令。
        *   执行自然语言处理任务 (内容生成、摘要、纠错、对话等)。
        *   **新增：执行与人脉相关的AI任务，如联系人信息提取、互动情感分析、亲密度计算、印象分析、关系维护建议生成等。**
        *   返回处理结果给后端。

5.  **云存储服务 (Cloud Storage - 可选但推荐):**
    *   **提供商示例:** Amazon S3, Google Cloud Storage, Azure Blob Storage。
    *   **职责:** 存储用户上传的媒体文件 (图片、音频、视频)，减轻数据库存储压力，并提供高效的文件访问。

## 二、数据流向 (关键用例)

以下是一些关键功能的数据流向示例：

1.  **用户注册/登录:**
    *   **客户端:** 用户输入注册信息 (邮箱、密码) 或登录凭据。
    *   **客户端 -> 后端API:** 发送注册/登录请求。
    *   **后端:**
        *   (注册) 验证信息，哈希密码，在数据库中创建用户记录。
        *   (登录) 验证凭据，与数据库中存储的用户信息比对。
        *   生成会话令牌 (例如JWT)。
    *   **后端API -> 客户端:** 返回成功/失败状态及会话令牌。
    *   **客户端:** 存储会话令牌，导航至主界面或显示错误信息。

2.  **创建日记条目 (手动):**
    *   **客户端:** 用户输入标题、富文本内容、选择心情、日记类型、添加标签、选择封面图片 `cover_image_attachment_id`、设置背景样式 `background_style_json`、自定义参数 `custom_settings_json`、排序索引 `sort_index`、上传图片/音频等。
    *   **客户端 -> 后端API (文件上传):** 如果有媒体文件，先将文件上传至云存储 (或通过后端中转)，获取文件URL和 `attachment_id`。
    *   **客户端 -> 后端API (创建日记):** 发送日记数据 (文本内容、心情、标签、日记类型、封面图片ID、背景样式JSON、自定义设置JSON、排序索引、媒体文件信息包括 `attachment_id` 和 `attachment_purpose` 等)。
    *   **后端:** 验证数据，将日记条目与用户ID关联，存入数据库。
    *   **后端API -> 客户端:** 返回成功/失败状态及新创建的日记条目数据。
    *   **客户端:** 更新UI，显示新日记。

3.  **AI辅助写作 (例如：句子补全):**
    *   **客户端:** 用户在编辑器中输入文本，触发AI辅助功能 (例如：点击"补全句子"按钮)。
    *   **客户端 -> 后端API:** 发送当前文本内容、用户选择的AI模型API标识、以及辅助类型 (例如："sentence_completion")。
    *   **后端 (AI集成服务):**
        *   根据用户选择的AI模型，准备请求参数和prompt。
        *   从安全存储中获取对应AI模型的API密钥。
        *   **后端 -> 第三方AI服务API:** 发送包含文本和指令的请求。
        *   **第三方AI服务API -> 后端:** 返回AI生成的建议文本。
    *   **后端API -> 客户端:** 返回AI生成的建议文本。
    *   **客户端:** 在UI中向用户展示建议，用户可选择采纳或忽略。

4.  **AI对话式记录日记:**
    *   **客户端:** 用户启动AI对话模式，通过语音或文本输入与AI交互。
    *   **客户端 (语音转文本):** 如果是语音输入，先进行本地或云端语音转文字。
    *   **客户端 -> 后端API:** 发送用户语句、当前对话上下文 (历史消息)、选择的AI模型API标识。
    *   **后端 (AI集成服务):**
        *   构建发送给AI模型的对话请求 (包含历史和当前用户输入)。
        *   **后端 -> 第三方AI服务API:** 发送对话请求。
        *   **第三方AI服务API -> 后端:** 返回AI的回复 (可能是引导性问题、确认信息或生成的日记片段)。
    *   **后端API -> 客户端:** 返回AI的回复。
    *   **客户端:** 显示AI回复，用户继续对话。此过程可多次迭代。
    *   **(对话结束/保存时) 客户端 -> 后端API:** 用户确认将对话内容整理为日记后，发送最终整理好的日记内容。
    *   **后端:** 将日记条目存入数据库。
    *   **后端API -> 客户端:** 返回成功状态。

5.  **切换AI模型API:**
    *   **客户端:** 用户在设置页面选择不同的AI模型API，可能需要输入新的API密钥 (如果该模型需要用户自备密钥)。
    *   **客户端 -> 后端API:** 发送所选AI模型标识和用户提供的API密钥 (如果适用)。
    *   **后端:**
        *   验证API密钥的有效性 (如果可能，例如通过向AI服务发送一个测试请求)。
        *   在数据库中更新用户的AI模型偏好设置和加密存储的API密钥 (如果由用户提供)。
    *   **后端API -> 客户端:** 返回成功/失败状态。
    *   **客户端:** 更新UI，后续AI功能将使用新选择的模型。

6.  **数据同步 (跨设备):**
    *   **客户端 (设备A):** 用户创建/修改数据。
    *   **客户端 (设备A) -> 后端API:** 发送变更数据。
    *   **后端:** 更新数据库。
    *   **客户端 (设备B):** 定期或在应用启动时向后端API请求最新数据或增量更新。
    *   **后端API -> 客户端 (设备B):** 返回需要同步的数据。
    *   **客户端 (设备B):** 更新本地数据和UI。

## 三、关键考虑因素

*   **安全性:** API密钥的存储与传输、用户数据的加密 (传输中和静态)、防止常见Web漏洞 (XSS, SQL注入等)。
*   **可扩展性:** 后端服务应设计为可水平扩展，以应对用户量增长。数据库选择和设计也需考虑扩展性。**人脉关系服务也应遵循此原则。**
*   **AI模型API的抽象:** 后端应设计一个通用的AI服务接口，以便轻松添加或切换不同的AI模型提供商，而无需大幅修改核心业务逻辑。**此抽象对于人脉相关的AI分析同样重要。**
*   **成本控制:** AI API调用通常是按量付费，需要监控使用情况，并可能需要为用户设置使用限制或提供不同级别的订阅服务。**涉及联系人互动分析和建议生成的AI调用也需纳入成本考量。**
*   **错误处理与容错:** 客户端和后端都需要健壮的错误处理机制，优雅地处理网络问题、AI服务不可用或API错误等情况。
*   **数据隐私:** 明确告知用户AI功能如何使用他们的数据 (**包括联系人信息、互动内容等用于分析和生成建议**)，并遵守相关隐私法规。提供用户控制数据共享和AI分析的选项。
*   **异步处理:** 对于耗时的AI分析任务 (如复杂的亲密度计算、批量联系人信息处理)，应考虑使用异步任务队列 (如Celery, RabbitMQ) 处理，避免阻塞API请求，并及时通过回调或轮询更新客户端状态。





# AI日记App数据库设计

基于先前定义的核心功能和数据流，以下是AI日记App的建议数据库表结构设计。我们将主要使用关系型数据库的模式，但某些字段（如富文本内容或AI交互日志）可能适合存储为JSON或文本类型。

## 表结构定义

**1. `users` 表 (用户信息)**

*   `user_id` (主键, INT, 自增) - 用户唯一标识符
*   `email` (VARCHAR(255), 唯一, 非空) - 用户邮箱
*   `password_hash` (VARCHAR(255), 非空) - 哈希后的用户密码
*   `nickname` (VARCHAR(100), 可空) - 用户昵称
*   `avatar_url` (VARCHAR(512), 可空) - 用户头像URL
*   `preferred_ai_model_id` (INT, 外键，关联 `ai_models.model_id`, 可空) - 用户偏好的AI模型
*   `created_at` (TIMESTAMP, 默认当前时间) - 用户创建时间
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新) - 用户信息最后更新时间

**2. `diaries` 表 (日记条目)**

*   `diary_id` (主键, INT, 自增) - 日记唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 所属用户ID
*   `title` (VARCHAR(255), 可空) - 日记标题
*   `content_text` (TEXT, 可空) - 日记的纯文本内容 (用于搜索和AI处理)
*   `content_html` (TEXT, 可空) - 日记的富文本内容 (HTML格式)
*   `mood` (VARCHAR(50), 可空) - 当天心情 (例如: "开心", "平静", "难过")
*   `entry_date` (DATE, 非空) - 日记对应的日期
*   `created_at` (TIMESTAMP, 默认当前时间) - 条目创建时间
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新) - 条目最后更新时间
*   `is_archived` (BOOLEAN, 默认 FALSE) - 是否已归档
*   `is_pinned` (BOOLEAN, 默认 FALSE) - 是否置顶

**3. `lists` 表 (清单/待办事项列表)**

*   `list_id` (主键, INT, 自增) - 清单唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 所属用户ID
*   `title` (VARCHAR(255), 非空) - 清单标题
*   `description` (TEXT, 可空) - 清单描述
*   `created_at` (TIMESTAMP, 默认当前时间) - 清单创建时间
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新) - 清单最后更新时间

**4. `list_items` 表 (清单项目)**

*   `item_id` (主键, INT, 自增) - 清单项目唯一标识符
*   `list_id` (外键, INT, 关联 `lists.list_id`, 非空) - 所属清单ID
*   `content` (TEXT, 非空) - 项目内容
*   `is_completed` (BOOLEAN, 默认 FALSE) - 是否已完成
*   `due_date` (TIMESTAMP, 可空) - 截止日期
*   `order_index` (INT, 默认 0) - 项目在清单中的排序索引
*   `created_at` (TIMESTAMP, 默认当前时间) - 项目创建时间
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新) - 项目最后更新时间

**5. `tags` 表 (标签)**

*   `tag_id` (主键, INT, 自增) - 标签唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 创建该标签的用户ID (标签可以是用户私有的)
*   `name` (VARCHAR(100), 非空) - 标签名称
*   `color` (VARCHAR(7), 可空) - 标签颜色 (例如: "#FF0000")
*   `created_at` (TIMESTAMP, 默认当前时间)
*   约束: (`user_id`, `name`) 组合唯一，确保同一用户下标签名不重复。

**6. `diary_tags` 表 (日记-标签关联表，多对多)**

*   `diary_id` (外键, INT, 关联 `diaries.diary_id`, 非空)
*   `tag_id` (外键, INT, 关联 `tags.tag_id`, 非空)
*   主键: (`diary_id`, `tag_id`)

**7. `list_tags` 表 (清单-标签关联表，多对多)**

*   `list_id` (外键, INT, 关联 `lists.list_id`, 非空)
*   `tag_id` (外键, INT, 关联 `tags.tag_id`, 非空)
*   主键: (`list_id`, `tag_id`)

**8. `media_attachments` 表 (媒体附件)**

*   `attachment_id` (主键, INT, 自增) - 附件唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 上传用户ID
*   `diary_id` (外键, INT, 关联 `diaries.diary_id`, 可空) - 关联的日记ID (如果附件属于日记)
*   `list_item_id` (外键, INT, 关联 `list_items.item_id`, 可空) - 关联的清单项目ID (如果附件属于清单项，较少见)
*   `file_url` (VARCHAR(512), 非空) - 文件在云存储上的URL
*   `file_type` (VARCHAR(50), 非空) - 文件类型 (例如: "image/jpeg", "audio/mp3", "video/mp4")
*   `file_name` (VARCHAR(255), 可空) - 原始文件名
*   `file_size_bytes` (BIGINT, 可空) - 文件大小 (字节)
*   `created_at` (TIMESTAMP, 默认当前时间) - 上传时间

**9. `ai_models` 表 (AI模型信息)**

*   `model_id` (主键, INT, 自增) - AI模型唯一标识符
*   `model_name` (VARCHAR(100), 非空, 唯一) - 模型名称 (例如: "GPT-4", "Claude 3 Sonnet")
*   `api_provider` (VARCHAR(100), 非空) - API提供商 (例如: "OpenAI", "Anthropic")
*   `api_endpoint_identifier` (VARCHAR(255), 非空) - 后端用于识别调用哪个API的标识符
*   `description` (TEXT, 可空) - 模型描述
*   `is_active` (BOOLEAN, 默认 TRUE) - 该模型是否可用
*   `requires_user_api_key` (BOOLEAN, 默认 FALSE) - 是否需要用户提供自己的API Key

**10. `user_ai_model_configs` 表 (用户AI模型配置，例如API Key)**

*   `config_id` (主键, INT, 自增)
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空)
*   `model_id` (外键, INT, 关联 `ai_models.model_id`, 非空)
*   `api_key_encrypted` (VARCHAR(512), 可空) - 用户提供的加密后的API Key (如果 `ai_models.requires_user_api_key` 为 TRUE)
*   `custom_settings_json` (JSON, 可空) - 用户针对该模型的特定配置 (例如温度、最大token等)
*   `created_at` (TIMESTAMP, 默认当前时间)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)
*   约束: (`user_id`, `model_id`) 组合唯一

**11. `ai_interaction_logs` 表 (AI交互日志 - 用于分析和调试)**

*   `log_id` (主键, BIGINT, 自增) - 日志唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空)
*   `model_id` (外键, INT, 关联 `ai_models.model_id`, 非空) - 使用的AI模型
*   `interaction_type` (VARCHAR(100), 非空) - 交互类型 (例如: "diary_assist_completion", "chat_diary_creation", "list_item_generation")
*   `prompt_text` (TEXT, 可空) - 发送给AI的完整提示
*   `response_text` (TEXT, 可空) - AI返回的原始响应
*   `request_timestamp` (TIMESTAMP, 非空) - 请求AI的时间
*   `response_timestamp` (TIMESTAMP, 可空) -收到AI响应的时间
*   `duration_ms` (INT, 可空) - 交互耗时 (毫秒)
*   `success` (BOOLEAN, 非空) - 交互是否成功
*   `error_message` (TEXT, 可空) - 如果失败，记录错误信息
*   `tokens_used` (INT, 可空) - (如果API提供) 本次交互消耗的token数
*   `related_diary_id` (外键, INT, 关联 `diaries.diary_id`, 可空)
*   `related_list_id` (外键, INT, 关联 `lists.list_id`, 可空)

**12. `app_settings` 表 (用户应用设置)**

*   `setting_id` (主键, INT, 自增)
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空, 唯一) - 每个用户一条设置记录
*   `theme` (VARCHAR(50), 默认 "light") - 应用主题 ("light", "dark")
*   `default_font_size` (INT, 默认 14)
*   `enable_daily_reminder` (BOOLEAN, 默认 FALSE)
*   `reminder_time` (TIME, 可空) - 提醒时间
*   `enable_cloud_sync` (BOOLEAN, 默认 TRUE)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)

## 关系图 (ERD) 概念

*   `users` 是核心，许多表都通过 `user_id` 与之关联。
*   `diaries` 和 `lists` 是主要的内容实体，都属于某个 `user`。
*   `list_items` 从属于 `lists`。
*   `tags` 由 `user` 创建，并通过中间表 `diary_tags` 和 `list_tags` 与 `diaries` 和 `lists` 建立多对多关系。
*   `media_attachments` 可以关联到 `diaries` 或 `list_items`。
*   `ai_models` 是预定义的模型列表。
*   `user_ai_model_configs` 存储用户针对特定 `ai_models` 的配置 (如API Key)。
*   `ai_interaction_logs` 记录用户与AI的交互历史。
*   `app_settings` 存储用户的个性化应用设置。

## 注意事项

*   **索引:** 需要在常用查询字段上创建索引，例如外键、日期字段、用户ID、标签名等，以提高查询性能。
*   **数据类型:** TEXT类型用于存储较长的文本，JSON类型可以灵活存储结构化但模式不固定的数据 (如自定义设置)。
*   **安全性:** `password_hash` 必须使用强哈希算法 (如 bcrypt 或 Argon2)。`api_key_encrypted` 必须进行对称或非对称加密存储，密钥管理是关键。
*   **可扩展性:** 随着功能增加，可能需要添加更多表或修改现有表结构。例如，如果引入社交功能，可能需要 `friends` 表、`shares` 表等。
*   **数据一致性:** 尽可能使用数据库的外键约束来保证数据引用的完整性。

这份数据库设计为AI日记App提供了一个坚实的基础。在实际开发过程中，可能还需要根据具体实现细节进行调整和优化。

## 新增：人脉关系管理与情商辅助功能相关表

为了支持新增的人脉关系管理与情商辅助功能，我们需要引入以下新的数据表：

**13. `contacts` 表 (联系人/人物档案)**

*   `contact_id` (主键, INT, 自增) - 联系人唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 所属用户ID (表示这个联系人是哪个用户记录的)
*   `name` (VARCHAR(255), 非空) - 联系人姓名
*   `nickname` (VARCHAR(100), 可空) - 昵称
*   `avatar_url` (VARCHAR(512), 可空) - 联系人头像URL (可以是用户上传或链接)
*   `relation_type` (VARCHAR(100), 可空) - 关系类型 (例如: "朋友", "家人", "同事", "合作伙伴")
*   `gender` (VARCHAR(20), 可空) - 性别
*   `birth_date` (DATE, 可空) - 生日
*   `contact_info_json` (JSON, 可空) - 其他联系方式 (例如: `{"phone": "...", "email": "...", "social_media": {"wechat": "..."}}`)
*   `interests_hobbies_text` (TEXT, 可空) - 兴趣爱好 (文本描述，AI可分析)
*   `preferences_text` (TEXT, 可空) - 口味偏好、禁忌等 (文本描述，AI可分析)
*   `important_dates_json` (JSON, 可空) - 其他重要日期 (例如: `[{"name": "结婚纪念日", "date": "YYYY-MM-DD", "notes": "..."}, ...]`)
*   `notes` (TEXT, 可空) - 关于此人的其他备注或自由文本记录
*   `created_at` (TIMESTAMP, 默认当前时间)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)

**14. `contact_interactions` 表 (联系人互动记录)**

*   `interaction_id` (主键, INT, 自增) - 互动记录唯一标识符
*   `contact_id` (外键, INT, 关联 `contacts.contact_id`, 非空) - 关联的联系人ID
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 执行此记录的用户ID
*   `interaction_type` (VARCHAR(100), 可空) - 互动类型 (例如: "会面", "通话", "短信", "邮件", "共同活动", "礼物赠送")
*   `title` (VARCHAR(255), 可空) - 互动标题或简要描述
*   `description_text` (TEXT, 可空) - 详细描述
*   `interaction_date` (TIMESTAMP, 非空) - 互动发生的时间
*   `location` (VARCHAR(255), 可空) - 互动地点
*   `sentiment_score` (DECIMAL(3,2), 可空) - AI分析的情感得分 (例如: -1.0 到 1.0)
*   `key_topics_json` (JSON, 可空) - AI提取的关键议题或标签 (例如: `["项目进展", "家庭生活"]`)
*   `monetary_transaction_json` (JSON, 可空) - 金钱往来记录 (例如: `{"type": "lend", "amount": 100, "currency": "CNY", "status": "pending"}`)
*   `related_diary_id` (外键, INT, 关联 `diaries.diary_id`, 可空) - 关联的日记ID
*   `related_list_id` (外键, INT, 关联 `lists.list_id`, 可空) - 关联的清单ID
*   `created_at` (TIMESTAMP, 默认当前时间)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)

**15. `contact_tags` 表 (联系人-标签关联表，多对多)**

*   `contact_id` (外键, INT, 关联 `contacts.contact_id`, 非空)
*   `tag_id` (外键, INT, 关联 `tags.tag_id`, 非空)
*   主键: (`contact_id`, `tag_id`)

**16. `gifts` 表 (礼物记录)**

*   `gift_id` (主键, INT, 自增) - 礼物记录唯一标识符
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空) - 记录此礼物的用户ID
*   `contact_id` (外键, INT, 关联 `contacts.contact_id`, 可空) - 关联的联系人 (送礼对象或收礼来源)
*   `direction` (VARCHAR(20), 非空) - 礼物方向 ("sent" - 送出, "received" -收到)
*   `gift_name` (VARCHAR(255), 非空) - 礼物名称
*   `description` (TEXT, 可空) - 礼物描述
*   `gift_date` (DATE, 非空) - 送出/收到礼物的日期
*   `occasion` (VARCHAR(100), 可空) - 场合 (例如: "生日", "节日", "感谢")
*   `value_estimate_json` (JSON, 可空) - 估值 (例如: `{"amount": 200, "currency": "CNY"}`)
*   `photo_url` (VARCHAR(512), 可空) - 礼物照片URL
*   `notes` (TEXT, 可空) - 备注
*   `created_at` (TIMESTAMP, 默认当前时间)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)

**17. `relationship_insights` 表 (关系洞察)**

*   `insight_id` (主键, INT, 自增) - 洞察记录唯一标识符
*   `contact_id` (外键, INT, 关联 `contacts.contact_id`, 非空, 唯一) - 每个联系人一条最新的洞察记录 (或可按时间记录历史洞察)
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空)
*   `intimacy_score` (DECIMAL(5,2), 可空) - AI计算的亲密度评分 (例如 0-100)
*   `intimacy_trend` (VARCHAR(50), 可空) - 亲密度趋势 (例如: "rising", "falling", "stable")
*   `last_contact_date` (TIMESTAMP, 可空) - 最近联系日期
*   `communication_frequency_json` (JSON, 可空) - 沟通频率分析 (例如: `{"period": "month", "count": 5}`)
*   `impression_keywords_json` (JSON, 可空) - AI分析的印象关键词 (例如: `["helpful", "funny"]`)
*   `suggested_actions_json` (JSON, 可空) - AI建议的关系维护行动 (例如: `[{"action": "send_greeting", "reason": "long_time_no_see"}]`)
*   `generated_at` (TIMESTAMP, 默认当前时间) - 此洞察生成的时间

**18. `contact_reminders` 表 (联系人相关提醒)**

*   `reminder_id` (主键, INT, 自增) - 提醒唯一标识符
*   `contact_id` (外键, INT, 关联 `contacts.contact_id`, 非空) - 关联的联系人ID
*   `user_id` (外键, INT, 关联 `users.user_id`, 非空)
*   `reminder_type` (VARCHAR(100), 非空) - 提醒类型 (例如: "birthday", "anniversary", "follow_up", "custom")
*   `reminder_date` (TIMESTAMP, 非空) - 提醒日期和时间
*   `description` (TEXT, 可空) - 提醒描述
*   `is_recurring` (BOOLEAN, 默认 FALSE) - 是否重复提醒
*   `recurrence_rule` (VARCHAR(255), 可空) - 重复规则 (例如 RRule格式)
*   `is_active` (BOOLEAN, 默认 TRUE) - 提醒是否激活
*   `created_at` (TIMESTAMP, 默认当前时间)
*   `updated_at` (TIMESTAMP, 默认当前时间，更新时自动更新)

## 关系图 (ERD) 概念

*   `users` 是核心，许多表都通过 `user_id` 与之关联。
*   `diaries` 和 `lists` 是主要的内容实体，都属于某个 `user`。
*   `list_items` 从属于 `lists`。
*   `tags` 由 `user` 创建，并通过中间表 `diary_tags` 和 `list_tags` 与 `diaries` 和 `lists` 建立多对多关系。**新增：`contacts` 表也通过 `contact_tags` 与 `tags` 建立多对多关系。**
*   `media_attachments` 可以关联到 `diaries` 或 `list_items`。**新增：`contacts` 的头像 (`avatar_url`) 和 `gifts` 的照片 (`photo_url`) 可以是URL，如果需要应用内管理这些图片，则 `media_attachments` 表可以扩展用途或新增类似表。**
*   `ai_models` 是预定义的模型列表。
*   `user_ai_model_configs` 存储用户针对特定 `ai_models` 的配置 (如API Key)。
*   `ai_interaction_logs` 记录用户与AI的交互历史。
*   `app_settings` 存储用户的个性化应用设置。
*   **新增：`contacts` 表用于存储详细的人物档案信息，隶属于特定 `user`。**
*   **新增：`contact_interactions` 表记录用户与 `contacts` 之间的往来事件，关联到 `contacts` 和 `users`。**
*   **新增：`gifts` 表记录用户送出或收到的礼物，关联到 `users` 和可选的 `contacts`。**
*   **新增：`relationship_insights` 表存储AI为用户生成的关于其与特定 `contacts` 关系的洞察。**
*   **新增：`contact_reminders` 表存储用户为特定 `contacts` 设置的提醒。**

## 注意事项

*   **索引:** 需要在常用查询字段上创建索引，例如外键、日期字段、用户ID、标签名、**联系人姓名 (`contacts.name`)、互动日期 (`contact_interactions.interaction_date`)、提醒日期 (`contact_reminders.reminder_date`)** 等，以提高查询性能。
*   **数据类型:** TEXT类型用于存储较长的文本，JSON类型可以灵活存储结构化但模式不固定的数据 (如自定义设置、**联系方式 `contacts.contact_info_json`、重要日期 `contacts.important_dates_json`、金钱往来 `contact_interactions.monetary_transaction_json` 等**)。
*   **安全性:** `password_hash` 必须使用强哈希算法 (如 bcrypt 或 Argon2)。`api_key_encrypted` 必须进行对称或非对称加密存储，密钥管理是关键。**联系人信息、互动记录等敏感数据在传输和存储时也需考虑加密。**
*   **可扩展性:** 随着功能增加，可能需要添加更多表或修改现有表结构。例如，如果引入社交功能，可能需要 `friends` 表、`shares` 表等。
*   **数据一致性:** 尽可能使用数据库的外键约束来保证数据引用的完整性。
*   **数据隐私与合规性:** 对于联系人数据、互动记录等个人信息，需要严格遵守数据隐私法规 (如GDPR, CCPA)，明确告知用户数据用途，并提供用户控制数据共享和删除的权利。**AI分析所用的数据也应在此范畴内。**

这份数据库设计为AI日记App提供了一个坚实的基础。在实际开发过程中，可能还需要根据具体实现细节进行调整和优化。





# AI日记App页面与UI设计

本文档将详细描述AI日记App所需的主要页面及其前端UI布局和交互设计，旨在提供清晰、直观且用户友好的体验，同时有效集成AI功能。

## 一、通用UI/UX原则

*   **简洁直观:** 界面设计应保持简洁，避免不必要的复杂性，确保用户可以轻松找到并使用各项功能。
*   **一致性:** 在整个应用中保持设计语言、图标、颜色和交互模式的一致性。
*   **反馈及时:** 对于用户的操作（点击、保存、AI请求等）应提供即时反馈（加载指示器、成功/错误提示）。
*   **可访问性 (A11y):** 考虑屏幕阅读器用户，确保足够的色彩对比度，提供文本替代方案等。
*   **响应式设计:** 确保在不同尺寸的设备（手机、平板、Web浏览器）上都能提供良好的用户体验。
*   **暗黑模式/主题:** 提供浅色和深色主题选项，允许用户自定义部分视觉元素。

## 二、主要页面设计

### 1. 启动与认证页面

*   **启动页 (Splash Screen):**
    *   **UI:** 应用Logo，简洁的背景。
    *   **交互:** 短暂显示后自动跳转到登录页或主页 (如果用户已登录)。
*   **注册页 (Sign Up):**
    *   **UI:** 输入框 (邮箱、密码、确认密码、昵称-可选)，注册按钮，已有账户登录链接。
    *   **交互:** 表单验证，密码强度提示，成功后跳转登录或直接进入主页。
*   **登录页 (Sign In):**
    *   **UI:** 输入框 (邮箱、密码)，登录按钮，忘记密码链接，创建新账户链接，可选的社交登录按钮 (Google, Apple等)。
    *   **交互:** 表单验证，成功后跳转主页。
*   **忘记密码页 (Forgot Password):**
    *   **UI:** 输入框 (邮箱)，发送重置链接按钮。
    *   **交互:** 发送密码重置邮件。

### 2. 主仪表盘/主页 (Dashboard/Home)

*   **UI:**
    *   **顶部:** 欢迎语/用户昵称，搜索图标，设置图标。
    *   **主要内容区域:**
        *   快速操作按钮 (例如："写新日记"，"新建清单"，"AI对话记录")。
        *   近期日记条目预览 (卡片式，显示标题、日期、部分内容摘要、心情图标)。
        *   近期清单预览 (卡片式，显示标题、未完成项目数)。
        *   (可选) AI每日灵感/提示卡片。
        *   (可选) 日历小部件，高亮有条目的日期。
    *   **底部导航栏 (Mobile):** 日记、清单、AI对话、搜索、我的/设置。
    *   **侧边导航栏 (Web):** 类似底部导航栏的功能，可展开/收起。
*   **交互:** 点击预览卡片跳转到对应条目/清单详情。点击快速操作按钮进入相应创建页面。

### 3. 日记条目创建/编辑页 (Diary Entry Create/Edit)

*   **UI:**
    *   **顶部:** 返回按钮，保存按钮 (或自动保存指示)，更多选项菜单 (删除、分享、导出、查看历史版本-高级)。
    *   **日期选择器:** 默认为当天，允许用户修改。
    *   **标题输入框。**
    *   **富文本编辑器:**
        *   工具栏: 字体样式 (粗体、斜体、下划线)，列表 (无序、有序、待办)，标题级别，引用，代码块，插入链接，(可选) 插入表格。
        *   内容编辑区域。
    *   **AI辅助工具栏/按钮 (集成在编辑器旁或浮动):**
        *   图标按钮: "内容生成/建议"，"内容改进 (语法、风格)"，"摘要"，"模板"。
        *   点击后可能弹出子菜单或对话框进行具体操作。
    *   **心情选择器:** 一组心情图标/表情供选择。
    *   **标签输入/选择器:** 允许输入新标签或从已有标签中选择，标签以药丸状显示。
    *   **附件区域:**
        *   "+"按钮添加图片/音频/视频。
        *   已添加附件的缩略图预览，可删除。
    *   **(可选) 位置标记。**
*   **交互:**
    *   输入时自动保存草稿。
    *   AI辅助: 选中文字或在光标处点击AI按钮，AI处理结果以内联建议、替换或新段落形式出现。
    *   媒体上传进度显示。

### 4. 日记条目查看页 (Diary Entry View)

*   **UI:**
    *   **顶部:** 返回按钮，编辑按钮，更多选项菜单 (删除、分享、导出)。
    *   **内容区域:** 显示日记标题、日期、心情、标签、富文本内容、附件 (图片直接显示，音频/视频可播放)。
*   **交互:** 点击编辑按钮跳转到编辑页。附件可全屏查看或播放。

### 5. 日记列表/时间轴/日历视图页 (Diary List/Timeline/Calendar View)

*   **UI:**
    *   **顶部:** 视图切换按钮 (列表、时间轴、日历)，筛选按钮 (按日期、标签、心情)，搜索框。
    *   **列表视图:** 按时间倒序排列日记条目，每条显示标题、日期、摘要、心情、标签。
    *   **时间轴视图:** 类似列表，但更强调时间线展示。
    *   **日历视图:** 月历形式，有日记的日期高亮或有标记，点击日期可查看当天日记列表或直接跳转。
    *   **浮动操作按钮 (FAB):** "+"号，点击创建新日记。
*   **交互:** 点击条目进入查看页。无限滚动加载更多条目。

### 6. 清单创建/编辑页 (List Create/Edit)

*   **UI:**
    *   **顶部:** 返回按钮，保存按钮 (或自动保存)，更多选项菜单 (删除、分享)。
    *   **清单标题输入框。**
    *   **清单描述输入框 (可选)。**
    *   **项目列表区域:**
        *   每个项目包含: 复选框 (标记完成)，项目内容输入框，(可选) 截止日期，拖拽排序控柄，删除按钮。
        *   "添加新项目"按钮/输入框。
    *   **AI辅助按钮 (例如："AI帮我生成任务"):** 基于清单标题或描述生成建议项目。
    *   **标签输入/选择器。**
*   **交互:** 项目内容输入后按回车或点击添加按钮创建新项目。拖拽调整项目顺序。勾选标记完成，已完成项目可置灰或移到底部。

### 7. 清单查看页 (List View)

*   **UI:**
    *   **顶部:** 返回按钮，编辑按钮，更多选项菜单。
    *   **内容区域:** 显示清单标题、描述、标签、项目列表 (带复选框和内容)。
*   **交互:** 点击编辑按钮跳转到编辑页。可直接在查看页勾选/取消勾选项目。

### 8. 清单概览页 (Lists Overview)

*   **UI:**
    *   **顶部:** 筛选按钮 (按标签、状态)，搜索框。
    *   **清单列表:** 卡片式或列表式展示所有清单，每项显示标题、未完成项目数、标签。
    *   **浮动操作按钮 (FAB):** "+"号，点击创建新清单。
*   **交互:** 点击清单卡片进入清单查看页。

### 9. AI对话界面页 (AI Chat Interface)

*   **UI:**
    *   **顶部:** 返回按钮，对话标题 (例如："AI日记助手")，(可选) 清空对话历史按钮。
    *   **对话区域:** 类似即时通讯应用的聊天气泡界面，区分用户输入和AI回复。
        *   用户输入气泡。
        *   AI回复气泡，可能包含文本、建议操作按钮 (例如："保存为日记"，"添加到清单")。
    *   **底部输入区域:**
        *   文本输入框，支持多行。
        *   发送按钮。
        *   麦克风图标 (用于语音输入，点击后变为录音状态指示)。
        *   (可选) 快速指令按钮 (例如："写日记"，"建清单"，"今天心情如何？")。
*   **交互:**
    *   用户输入文本或语音，发送给AI。
    *   AI回复后，用户可继续对话或根据AI建议操作。
    *   语音输入自动转为文本显示在输入框。
    *   如果AI生成了日记/清单内容，提供明确的保存入口。

### 10. 搜索页 (Search)

*   **UI:**
    *   **顶部:** 搜索输入框，清除按钮。
    *   **筛选选项:** 按类型 (日记/清单)，按日期范围，按标签，按心情。
    *   **结果区域:** 显示匹配的日记条目和清单，格式类似列表视图。
*   **交互:** 输入关键词实时显示搜索建议或结果。应用筛选条件后刷新结果。

### 11. 设置页 (Settings)

*   **UI:** 分组列表形式展示各项设置。
    *   **账户:**
        *   个人资料 (头像、昵称) - 点击进入编辑页。
        *   修改密码。
        *   登出账户。
    *   **AI设置:**
        *   **选择AI模型:** 下拉菜单或列表选择当前使用的AI模型 (例如：GPT-3.5, GPT-4, Claude Sonnet)。模型旁可显示简要描述或特性。
        *   **API密钥管理:** 如果所选模型需要用户自备API Key，则提供输入框。已保存的密钥应部分打码显示，提供编辑/清除选项。警告用户API Key的敏感性。
        *   (可选) AI行为微调 (例如：回复风格、创意程度滑块)。
    *   **外观:**
        *   主题选择 (浅色、深色、跟随系统)。
        *   字体大小调整。
    *   **通知:**
        *   每日写作提醒 (开关，时间选择)。
    *   **数据管理:**
        *   导出数据 (选择格式：PDF, TXT, Markdown，选择范围：全部/按日期)。
        *   导入数据 (支持特定格式)。
        *   (可选) 云同步开关及状态显示。
    *   **安全与隐私:**
        *   应用锁 (PIN码/指纹/面容ID)。
        *   隐私政策链接。
        *   数据使用说明 (特别是关于AI如何处理数据)。
    *   **关于:** 应用版本，开发者信息，反馈渠道，服务条款。
*   **交互:** 点击各项进入具体设置或执行操作。AI模型选择后，后续AI交互将使用新模型。

### 12. 笔记本/文件夹管理页 (Notebooks/Folders - 可选)

*   **UI:** 如果支持笔记本/文件夹功能。
    *   列表显示所有笔记本/文件夹。
    *   创建新笔记本/文件夹按钮。
    *   每个笔记本/文件夹可重命名、删除。
*   **交互:** 点击笔记本/文件夹进入其包含的日记/清单列表。

## 三、AI特定交互UI细节

*   **AI建议弹窗/内联提示:** 当AI提供写作建议时，可以是非模态的弹窗，或者直接在文本旁以内联形式高亮显示建议，用户可点击接受或拒绝。
*   **加载状态:** AI处理请求时，在相关按钮或区域显示加载动画 (例如：旋转的AI图标，进度条)。
*   **错误提示:** AI服务出错或API Key无效时，给出明确友好的错误提示和可能的解决方案。
*   **Token消耗提示 (可选):** 对于付费API，可以在设置或AI交互时提示大致的token消耗情况，帮助用户管理成本。

## 四、响应式设计考虑

*   **移动端优先:** 核心功能和交互首先为移动设备优化。
*   **Web端适配:**
    *   利用更大的屏幕空间，例如侧边导航栏代替底部导航栏。
    *   编辑器可以展示更多工具栏选项。
    *   列表和卡片可以显示更多信息。
    *   多栏布局 (例如：左侧日记列表，右侧日记内容)。

## 五、新增：人脉关系管理与情商辅助相关的页面与UI设计

以下页面和UI元素是为支持人脉关系管理与情商辅助功能而新增或增强的。

### 13. 人物首页/列表页 (Contacts Home/List)
    *   **UI (参考用户提供的图片，特别是首行左一、左二):**
        *   **顶部:** 页面标题 ("人物")，右侧可放置 "添加新人物" 图标 (+) 和 "搜索人物" 图标。
        *   **(可选) 快捷入口/提醒区域 (参考图片首行左一 "提醒" 部分):** 以卡片或列表形式显示近期的重要提醒，如好友生日（"李雷 生日 2024-08-16" 并有倒计时天数）、纪念日、或AI建议的重要互动提醒（"建议本周联系王芳"）。
        *   **人物列表区域:**
            *   采用卡片式或图文列表形式展示联系人。
            *   每项包含: 联系人圆形头像、姓名/昵称。
            *   (可选) 一行简要信息，如关系类型（"家人"、"同事"）、或与该人物相关的最新动态/提醒（"上次互动：3天前"，"下周生日"）。
            *   (可选) 列表项右侧可有快速操作，如直接进入与此人的"事件"或"对话"记录的快捷入口。
        *   **筛选/排序选项:** 可提供按关系类型、标签、亲密度（如果已计算）、姓名首字母等方式进行筛选和排序的控件。
    *   **底部导航栏:** "人物" 应作为一个独立的主要导航Tab。
    *   **交互:**
        *   点击联系人卡片/列表项，跳转到对应的 "人物详情页"。
        *   点击顶部的 "添加新人物" 图标，跳转到 "创建/编辑人物档案页"。
        *   点击提醒区域的内容，可直接跳转到对应的人物详情页或相关的提醒管理/互动记录页面。
        *   下拉刷新列表。

### 14. 创建/编辑人物档案页 (Create/Edit Contact Profile)
    *   **UI (参考用户提供的图片，特别是首行右二 "编辑个人" 的部分元素):**
        *   **顶部:** "返回" 按钮，页面标题 ("编辑人物"或"添加人物")，"保存" 按钮。
        *   **核心信息区:**
            *   人物头像区域：点击可从相册选择图片或拍照上传。
            *   姓名输入框 (必填)。
            *   昵称输入框。
            *   关系类型选择器 (例如：预设标签式按钮 "朋友", "家人", "同事", "自定义输入")。
            *   性别选择器 (例如："男", "女", "其他")。
        *   **重要日期区:**
            *   生日：日期选择器，可开启农历生日记录和提醒开关。
            *   可动态添加其他自定义重要日期条目，每条包含 "日期名称" 输入框 (例如："相识纪念日") 和对应的日期选择器，以及是否设置提醒的开关。
        *   **详细信息区 (可采用多行输入或折叠面板):**
            *   联系方式：可动态添加多个联系方式条目，每条包含类型选择 (电话、邮箱、微信、QQ等) 和对应的值输入框。
            *   兴趣爱好：文本输入框，允许多行输入，支持AI从文本中提取关键词作为标签建议。
            *   口味偏好/禁忌：文本输入框，允许多行输入。
            *   备注：多行文本输入框，用于记录其他杂项信息。
        *   **标签管理区:** 允许用户为此人添加或移除标签，标签以药丸状显示，点击可取消。提供标签输入框和从已有标签列表选择的功能。
        *   **(可选) AI辅助功能按钮:** 例如 "从日记/对话中智能填充信息"。
    *   **交互:**
        *   输入时对必填项进行校验。
        *   保存时，数据通过 `POST /api/v1/contacts` 或 `PUT /api/v1/contacts/{contact_id}` API提交。
        *   AI辅助填充信息后，允许用户进行编辑和确认。
        *   选择头像、日期等操作应有流畅的交互体验。

### 15. 人物详情页 (Contact Details)
    *   **UI (参考用户提供的图片，特别是首行右一、右二，以及第二行左一、右二，最右的部分元素):**
        *   **顶部:** "返回" 按钮，人物姓名/昵称作为页面标题，右侧可放置 "编辑" 图标和 "更多操作" 图标 (例如：删除此人、分享名片卡片、设置特别关注、添加到桌面快捷方式等)。
        *   **概要卡片区域 (Profile Header):**
            *   人物圆形头像 (可点击放大查看)。
            *   姓名/昵称，下方显示关系类型和用户为此人添加的标签云。
            *   (可选) 显示生日信息（例如 "2003年11月1日"）和距离生日天数或年龄。
            *   (可选) 亲密度分数或等级的简要展示。
        *   **信息分区导航:** 可采用顶部Tab导航条 (例如："资料", "事件", "对话", "印象", "亲密", "礼物", "足迹") 或可滚动的长页面并在关键位置设置锚点导航。
        *   **各分区内容详情:**
            *   **资料 (Profile/Info):** 详细展示在 "创建/编辑人物档案页" 中填写的各项信息，如生日、农历纪念、性别、籍贯/成都、兴趣爱好、口味偏好、联系方式、其他重要日期、备注等。只读形式，关键信息可高亮。
            *   **事件/往来 (Events/Interactions - 参考图片第二行左二 "事件"):**
                *   以时间轴或卡片列表形式展示与此人的互动记录 (`contact_interactions`)，按日期倒序排列。
                *   每条记录清晰显示：互动类型图标 (例如会议、用餐、通话)、互动标题/摘要、具体日期和时间、地点（如有）。
                *   列表顶部或底部有明显的 "添加新互动记录" 按钮。
                *   点击单条互动记录可跳转到互动详情页或进行编辑/删除。
            *   **对话 (Dialogues):** 若有专门记录的与此人相关的对话内容（可能来自日记中的对话类型，或AI对话记录），在此处以列表形式展示对话摘要和日期。
            *   **印象 (Impressions - 参考图片第二行右二 "印象" 和词云图):**
                *   以词云形式直观展示AI分析用户日记或互动记录中与此人相关的印象关键词 (例如：红豆标准、利息、人才好、事情、声音安全交通、用心时候、洗衣机、国贸成都等)。
                *   (可选) 用户也可以手动添加自己对此人的印象标签或简短描述。
            *   **亲密度 (Intimacy - 参考图片第二行最右 "亲密度" 和折线图):**
                *   显著位置显示当前量化的亲密度分数 (例如：88)。
                *   以折线图或柱状图形式展示亲密度分数随时间的变化趋势。
                *   (可选) 图表下方可列出近期影响亲密度变化的关键互动事件摘要。
            *   **礼物 (Gifts - 参考图片最下行右一 "礼物", 包含"收到"4件,"送出"6件的Tab):**
                *   Tab切换 "收到礼物" 和 "送出礼物"。
                *   列表展示礼物记录，包含：礼物图片(可选)、名称、赠与/收受日期、价值(可选)、赠送人/接收人(通常是对方或自己)、备注等。
                *   提供 "添加礼物记录" 按钮，跳转到礼物记录创建页。
            *   **相册 (Album):** 如果应用支持将媒体附件与人物关联，此处以相册形式展示与该人物相关的图片和短视频。
            *   **足迹 (Footprints - 参考图片最下行中间 "足迹(37)" 和地图):**
                *   嵌入式地图控件，在地图上标记出与该人物发生互动事件的地点。
                *   地图标记可聚合，点击标记可显示该地点的互动事件列表或摘要。
                *   (可选) 可切换为地点列表视图。
            *   **提醒 (Reminders):** 列表显示为该人物设置的所有有效提醒，包括类型、日期、描述。
        *   **(可选) AI建议区域:** 以卡片或小贴士形式，在页面合适位置展示AI提供的关于如何与此人相处、维护关系的建议。
    *   **交互:**
        *   Tab导航切换不同信息分区。
        *   页面内容可滚动。
        *   点击 "编辑" 图标跳转到 "创建/编辑人物档案页"。
        *   各列表（事件、礼物、提醒等）中的条目通常可点击查看详情、编辑或删除。
        *   地图和图表支持基本的交互操作 (如缩放、平移、点击查看数据点)。

### 16. 关系图谱页 (Relationship Map/Web)
    *   **UI (参考用户提供的图片第二行最左 "纪念" 的视觉风格):**
        *   主视图为一个动态的关系网络图。
        *   当前用户通常位于图谱的中心或作为起始浏览点。
        *   其他联系人作为节点围绕用户展示，节点可显示人物头像和姓名/昵称。
        *   节点之间的连线可以根据关系类型、亲密度或互动频率，在视觉上有所区分 (例如：不同颜色、粗细、动效)。
        *   提供筛选控件，允许用户按关系类型、标签、圈子等条件过滤显示的节点和连接。
        *   提供搜索功能，快速定位图谱中的某个人物。
    *   **交互:**
        *   支持图谱的拖拽、缩放、平移。
        *   点击某个联系人节点：
            *   可以高亮该节点及其一度连接关系。
            *   在侧边栏或弹窗中显示该联系人的简要信息卡片，并提供跳转到其完整 "人物详情页" 的链接。
        *   (高级功能) 可允许用户手动调整节点布局，或将某些节点组合成"圈子"。
        *   (高级功能) 选择两个人物节点，可以尝试在图上高亮他们之间的共同联系人或共同参与的关键事件。

### 17. 礼物管理页 (Gift Management)
    *   **UI (参考用户提供的图片最下行右一 "礼物" 页):**
        *   **顶部:** "返回" 按钮, 页面标题 ("礼物管理" 或 "我的礼物")，右侧可有 "添加礼物记录" 图标 (+)。
        *   **Tab导航:** 清晰区分 "我收到的" 和 "我送出的" 礼物列表。
        *   **礼物列表:**
            *   每条礼物记录以卡片形式展示，包含：
                *   礼物图片 (若有，优先展示)。
                *   礼物名称。
                *   赠与人/收受人 (根据Tab区分，例如在"我收到的"列表中显示赠与人)。
                *   赠送/接收日期。
                *   (可选) 礼物价值、场合（生日、节日等）、备注。
            *   列表可按日期、价值等排序。
        *   **统计信息 (可选):** 在列表上方或Tab旁边显示各类礼物的总数或总价值。
    *   **交互:**
        *   点击 "添加礼物记录" 图标或按钮，弹出或跳转到礼物信息录入表单页，表单字段包括：礼物名称、图片上传、赠送/接收方(可从联系人列表选择)、日期、价值、场合、备注等。
        *   点击列表中的某条礼物记录，可查看详情、编辑或删除该记录。

### 对现有主要页面的补充和调整

*   **主仪表盘/主页 (Dashboard/Home):**
    *   在 "主要内容区域"，可以考虑增加一个 "今日人物焦点" 或 "近期互动提醒" 的卡片式模块，展示即将到期的生日、纪念日，或AI建议关注的联系人。
    *   在底部导航栏 (Mobile) 或侧边导航栏 (Web) 中，应增加一个醒目的 "人物" 入口，与 "日记"、"清单" 等核心功能并列。

*   **日记条目创建/编辑页 (Diary Entry Create/Edit):**
    *   在富文本编辑器中或通过特定按钮，允许用户方便地 "@" 或关联某个联系人，这样日记内容可以与人物档案建立更强的联系。
    *   在保存日记时，如果内容涉及特定人物的互动，AI可以建议用户是否同时在对应人物的 "事件/往来" 中创建一条记录。

*   **设置页 (Settings):**
    *   **数据管理:**
        *   导出数据时，应允许用户选择是否包含 "人脉关系数据" (联系人档案、互动记录、礼物记录等)。
        *   导入数据时，如果导入格式支持，也应能导入人脉关系数据。
    *   **隐私设置:**
        *   需要有专门的条款说明 "联系人信息"、"互动记录" 等敏感数据是如何被存储、使用（尤其是在AI分析方面）和保护的。
        *   用户应能控制是否允许AI分析其人脉数据以提供洞察和建议。
    *   **(可选) 人脉功能特定设置:** 例如，亲密度计算的权重调整（高级用户）、默认的提醒提前天数等。

*   **搜索页 (Search):**
    *   搜索范围应扩展到包括联系人姓名、昵称、备注、互动记录中的关键词等。
    *   筛选条件中可以增加按 "人物" 筛选的选项。

这份对页面与UI设计的补充，旨在将新增的人脉关系管理与情商辅助功能无缝地融入到现有的应用框架中，并尽可能地从用户提供的视觉参考中汲取设计灵感。后续还需要通过原型设计和用户测试来验证和迭代这些设计。





# AI日记App前后端交互与API设计

本文档旨在详细说明AI日记App中前端与后端之间的交互方式，并定义主要的API接口设计。这将基于先前文档中确定的功能需求、系统架构、数据流和UI设计。

## 一、API设计原则

1.  **RESTful架构:** API将遵循REST原则，使用标准的HTTP方法 (GET, POST, PUT, DELETE) 和状态码。
2.  **JSON数据格式:** 所有请求体和响应体都将使用JSON格式。
3.  **身份认证:** 所有需要用户身份验证的API端点将使用JWT (JSON Web Tokens) 进行保护。Token将在登录后发放，并通过Authorization HTTP头部 (Bearer Token) 在后续请求中传递。
4.  **版本控制:** API将进行版本控制 (例如: `/api/v1/...`)，以便未来的迭代和兼容性。
5.  **一致的响应结构:** 所有API响应将遵循一致的结构，例如:
    ```json
    {
      "success": true, // boolean
      "data": { ... }, // 结果数据，成功时存在
      "message": "Operation successful", // 消息文本，可选
      "error": null // 错误对象，失败时存在
    }
    // 失败时:
    {
      "success": false,
      "data": null,
      "message": "An error occurred",
      "error": {
        "code": "ERROR_CODE",
        "details": "Specific error details..."
      }
    }
    ```
6.  **错误处理:** 使用标准的HTTP状态码来指示请求结果 (例如: 200 OK, 201 Created, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 500 Internal Server Error)。

## 二、API端点设计

以下是主要功能模块的API端点定义：

### 1. 认证 (Auth)

*   **`POST /api/v1/auth/register`**
    *   描述: 用户注册。
    *   请求体: `{ "email": "user@example.com", "password": "securepassword123", "nickname": "JohnDoe" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... }, "token": "jwt_token" } }`
*   **`POST /api/v1/auth/login`**
    *   描述: 用户登录。
    *   请求体: `{ "email": "user@example.com", "password": "securepassword123" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... }, "token": "jwt_token" } }`
*   **`POST /api/v1/auth/logout`**
    *   描述: 用户登出 (后端可将token加入黑名单)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "message": "Logged out successfully" }`
*   **`POST /api/v1/auth/refresh-token`**
    *   描述: 刷新JWT。
    *   请求体: `{ "refreshToken": "refresh_token_value" }`
    *   响应体 (成功): `{ "success": true, "data": { "token": "new_jwt_token" } }`
*   **`POST /api/v1/auth/forgot-password`**
    *   描述: 请求密码重置邮件。
    *   请求体: `{ "email": "user@example.com" }`
*   **`POST /api/v1/auth/reset-password`**
    *   描述: 使用重置令牌设置新密码。
    *   请求体: `{ "resetToken": "some_token", "newPassword": "newSecurePassword" }`

### 2. 用户 (Users)

*   **`GET /api/v1/users/me`**
    *   描述: 获取当前登录用户信息。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "data": { "user_id": 1, "email": "...", "nickname": "...", "avatar_url": "..." } }`
*   **`PUT /api/v1/users/me`**
    *   描述: 更新当前登录用户信息 (例如昵称、头像)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "nickname": "NewNickname", "avatar_url": "new_url" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... } } }`

### 3. 日记 (Diaries)

*   **`POST /api/v1/diaries`**
    *   描述: 创建新日记条目。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "title": "My Day", "content_text": "...", "content_html": "<p>...</p>", "mood": "Happy", "entry_date": "YYYY-MM-DD", "tags": ["work", "project"], "attachments": [{"file_url": "...", "file_type": "image/jpeg"}] }`
    *   响应体 (成功): `{ "success": true, "data": { "diary": { ... } } }`
*   **`GET /api/v1/diaries`**
    *   描述: 获取用户日记列表 (支持分页、筛选、排序)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?page=1&limit=10&sort_by=entry_date&order=desc&mood=Happy&tag=work&date_from=YYYY-MM-DD&date_to=YYYY-MM-DD`
    *   响应体 (成功): `{ "success": true, "data": { "diaries": [{...}, {...}], "pagination": { ... } } }`
*   **`GET /api/v1/diaries/{diary_id}`**
    *   描述: 获取单个日记条目详情。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`PUT /api/v1/diaries/{diary_id}`**
    *   描述: 更新指定日记条目。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: (同创建，但字段可选)
*   **`DELETE /api/v1/diaries/{diary_id}`**
    *   描述: 删除指定日记条目。
    *   请求头: `Authorization: Bearer <jwt_token>`

### 4. 清单 (Lists & List Items)

*   **`POST /api/v1/lists`**
    *   描述: 创建新清单。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "title": "Shopping List", "description": "...", "tags": ["groceries"] }`
*   **`GET /api/v1/lists`**
    *   描述: 获取用户清单列表 (支持分页、筛选)。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`GET /api/v1/lists/{list_id}`**
    *   描述: 获取单个清单详情及其项目。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`PUT /api/v1/lists/{list_id}`**
    *   描述: 更新指定清单信息 (标题、描述)。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`DELETE /api/v1/lists/{list_id}`**
    *   描述: 删除指定清单及其所有项目。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`POST /api/v1/lists/{list_id}/items`**
    *   描述: 向清单添加新项目。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "content": "Buy milk", "due_date": "YYYY-MM-DDTHH:mm:ssZ" }`
*   **`PUT /api/v1/lists/{list_id}/items/{item_id}`**
    *   描述: 更新清单项目 (内容、完成状态、截止日期)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "content": "Buy almond milk", "is_completed": true }`
*   **`DELETE /api/v1/lists/{list_id}/items/{item_id}`**
    *   描述: 删除清单项目。
    *   请求头: `Authorization: Bearer <jwt_token>`

### 5. 标签 (Tags)

*   **`POST /api/v1/tags`**
    *   描述: 创建新标签 (用户私有)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "name": "Personal", "color": "#3498DB" }`
*   **`GET /api/v1/tags`**
    *   描述: 获取用户的所有标签。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   *(日记和清单的标签管理通过各自的端点实现，例如 `POST /diaries/{diary_id}/tags`)*

### 6. AI交互 (AI Interaction)

*   **`POST /api/v1/ai/assist/writing`**
    *   描述: 请求AI写作辅助。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "model_id": "gpt-3.5-turbo", "task_type": "sentence_completion" / "grammar_correction" / "summarize" / "style_suggestion", "context_text": "Current diary text...", "user_prompt": "Make this sound more reflective." }`
    *   响应体 (成功): `{ "success": true, "data": { "suggestion": "AI generated text..." } }`
*   **`POST /api/v1/ai/chat`**
    *   描述: 与AI进行对话式交互 (用于记录日记/清单)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "model_id": "claude-v2", "session_id": "optional_session_id", "messages": [{"role": "user", "content": "Hello AI"}, {"role": "assistant", "content": "Hello! How can I help you today?"}, {"role": "user", "content": "Create a diary entry for today."}] }`
    *   响应体 (成功): `{ "success": true, "data": { "reply": "Okay, what happened today?", "session_id": "updated_session_id" } }`
*   **`GET /api/v1/ai/models`**
    *   描述: 获取可用的AI模型列表。
    *   响应体 (成功): `{ "success": true, "data": { "models": [{ "model_id": 1, "model_name": "GPT-4", "api_provider": "OpenAI", "description": "...", "requires_user_api_key": false }, ...] } }`
*   **`PUT /api/v1/users/me/ai-config`**
    *   描述: 更新用户的AI模型偏好和API密钥。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "preferred_ai_model_id": 1, "api_keys": [{ "model_id": 2, "key": "user_provided_api_key_for_model_2" }] }` (API Key后端需加密存储)

### 7. 媒体附件 (Media Attachments)

*   **`POST /api/v1/attachments/upload`**
    *   描述: 上传媒体文件 (图片、音频)。通常使用 `multipart/form-data`。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "data": { "file_url": "https://cdn.example.com/path/to/file.jpg", "file_type": "image/jpeg" } }`
    *   *注意: 附件信息通常在创建/更新日记或清单项目时与主内容一起提交，此端点可用于预上传。*

### 8. 应用设置 (App Settings)

*   **`GET /api/v1/users/me/settings`**
    *   描述: 获取用户的应用设置。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`PUT /api/v1/users/me/settings`**
    *   描述: 更新用户的应用设置。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "theme": "dark", "enable_daily_reminder": true, "reminder_time": "20:00" }`

## 三、关键交互流程示例

1.  **用户登录:**
    *   前端: 用户提交邮箱和密码。
    *   前端 -> 后端: `POST /api/v1/auth/login` 带凭据。
    *   后端: 验证凭据，生成JWT。
    *   后端 -> 前端: 返回用户信息和JWT。
    *   前端: 存储JWT，导航到主页。

2.  **创建日记 (带AI辅助):**
    *   前端: 用户打开新日记页面，输入标题和部分内容。
    *   前端: 用户点击"AI补全句子"按钮。
    *   前端 -> 后端: `POST /api/v1/ai/assist/writing` 带当前文本、任务类型、所选AI模型ID。
    *   后端: 获取用户AI配置 (API Key等)，调用第三方AI模型API。
    *   第三方AI -> 后端: 返回建议文本。
    *   后端 -> 前端: 返回AI建议。
    *   前端: 显示建议，用户采纳或修改。
    *   前端: 用户完成编辑，点击保存。
    *   前端 -> 后端: `POST /api/v1/diaries` 带完整日记数据 (包括AI润色后的内容)。
    *   后端: 保存日记到数据库。
    *   后端 -> 前端: 返回成功和新日记数据。

3.  **AI对话记录日记:**
    *   前端: 用户进入AI对话界面，发送消息："帮我记录今天的日记"。
    *   前端 -> 后端: `POST /api/v1/ai/chat` 带消息历史和用户当前消息。
    *   后端: 调用第三方AI模型API进行对话处理。
    *   第三方AI -> 后端: 返回AI的回复 (例如："好的，今天发生了什么特别的事情吗？")。
    *   后端 -> 前端: 返回AI回复。
    *   前端: 显示AI回复，用户继续对话，逐步提供日记内容。
    *   (对话结束) 前端: 用户确认保存，将整理好的对话内容作为日记正文。
    *   前端 -> 后端: `POST /api/v1/diaries` 带日记数据。

4.  **切换AI模型:**
    *   前端: 用户在设置中选择新的AI模型，如果需要，输入该模型的API Key。
    *   前端 -> 后端: `PUT /api/v1/users/me/ai-config` 带选择的模型ID和API Key (如有)。
    *   后端: 验证并加密存储API Key，更新用户偏好模型。
    *   后端 -> 前端: 返回成功消息。
    *   前端: 后续AI请求将使用新配置。

## 四、AI模型API集成细节

*   **后端代理:** 后端服务将作为客户端与第三方AI模型API之间的代理。这有助于：
    *   安全管理API密钥 (不暴露给客户端)。
    *   统一不同AI提供商API的调用方式和响应格式 (通过适配器模式)。
    *   记录和监控AI API使用情况。
*   **API密钥管理:** 后端必须安全存储AI模型的API密钥。用户提供的密钥应加密存储。应用自身的全局密钥应通过环境变量或安全的配置服务管理。
*   **请求与响应适配:** 不同的AI模型API有不同的请求结构和响应格式。后端需要为每个支持的AI模型实现适配器，将内部统一的AI请求转换为特定模型的格式，并将模型的响应转换回内部统一格式。

这份前后端交互和API设计文档为AI日记App的开发提供了详细的指导。在实际开发中，可能需要根据具体的技术选型和进一步的需求进行微调。

## 五、新增：人脉关系管理与情商辅助API

以下API端点用于支持新增的人脉关系管理与情商辅助功能。

### 9. 联系人 (Contacts)

*   **`POST /api/v1/contacts`**
    *   描述: 创建新的联系人档案。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "name": "李雷", "nickname": "小雷", "avatar_url": "url_to_avatar", "relation_type": "朋友", "gender": "男", "birth_date": "1990-05-15", "contact_info_json": {"phone": "138..."}, "interests_hobbies_text": "喜欢篮球、音乐", "preferences_text": "不吃香菜", "important_dates_json": [{"name": "相识纪念日", "date": "2020-01-10"}], "notes": "大学同学", "tags": ["大学同学", "好友"] }`
    *   响应体 (成功): `{ "success": true, "data": { "contact": { "contact_id": 123, ... } } }`
*   **`GET /api/v1/contacts`**
    *   描述: 获取当前用户的所有联系人列表 (支持分页、筛选、排序)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?page=1&limit=20&sort_by=name&order=asc&relation_type=朋友&tag=重要`
    *   响应体 (成功): `{ "success": true, "data": { "contacts": [{...}, {...}], "pagination": { ... } } }`
*   **`GET /api/v1/contacts/{contact_id}`**
    *   描述: 获取指定联系人的详细信息 (包含档案、近期互动摘要、提醒、洞察等聚合信息)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "data": { "contact_details": { "profile": {...}, "recent_interactions": [{...}], "active_reminders": [{...}], "insights": {...}, "tags": [...] } } }`
*   **`PUT /api/v1/contacts/{contact_id}`**
    *   描述: 更新指定联系人的档案信息。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: (同创建，但字段可选，用于部分更新)
    *   响应体 (成功): `{ "success": true, "data": { "contact": { ... } } }`
*   **`DELETE /api/v1/contacts/{contact_id}`**
    *   描述: 删除指定联系人 (及其关联的互动、提醒、洞察等)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "message": "Contact deleted successfully" }`

### 10. 联系人互动 (Contact Interactions)

*   **`POST /api/v1/contacts/{contact_id}/interactions`**
    *   描述: 为指定联系人记录新的互动事件。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "interaction_type": "会面", "title": "共进午餐", "description_text": "讨论了项目A的进展。", "interaction_date": "YYYY-MM-DDTHH:mm:ssZ", "location": "市中心咖啡馆", "sentiment_score": 0.8, "key_topics_json": ["项目A"], "monetary_transaction_json": null, "related_diary_id": null }`
    *   响应体 (成功): `{ "success": true, "data": { "interaction": { "interaction_id": 456, ... } } }`
*   **`GET /api/v1/contacts/{contact_id}/interactions`**
    *   描述: 获取指定联系人的所有互动记录 (支持分页、筛选)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?page=1&limit=10&interaction_type=通话&date_from=YYYY-MM-DD`
    *   响应体 (成功): `{ "success": true, "data": { "interactions": [{...}, {...}], "pagination": { ... } } }`
*   **`PUT /api/v1/contacts/{contact_id}/interactions/{interaction_id}`**
    *   描述: 更新指定的互动记录。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: (同创建，但字段可选)
*   **`DELETE /api/v1/contacts/{contact_id}/interactions/{interaction_id}`**
    *   描述: 删除指定的互动记录。
    *   请求头: `Authorization: Bearer <jwt_token>`

### 11. 联系人提醒 (Contact Reminders)

*   **`POST /api/v1/contacts/{contact_id}/reminders`**
    *   描述: 为指定联系人创建新的提醒。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "reminder_type": "birthday", "reminder_date": "YYYY-MM-DDTHH:mm:ssZ", "description": "买生日礼物", "is_recurring": true, "recurrence_rule": "FREQ=YEARLY" }`
*   **`GET /api/v1/contacts/{contact_id}/reminders`**
    *   描述: 获取指定联系人的所有提醒。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`PUT /api/v1/contacts/{contact_id}/reminders/{reminder_id}`**
    *   描述: 更新指定提醒。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`DELETE /api/v1/contacts/{contact_id}/reminders/{reminder_id}`**
    *   描述: 删除指定提醒。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`GET /api/v1/reminders`** (全局提醒)
    *   描述: 获取当前用户所有联系人的有效提醒 (例如用于首页提醒模块)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?upcoming_days=7` (获取未来7天内的提醒)

### 12. 关系洞察 (Relationship Insights)

*   **`GET /api/v1/contacts/{contact_id}/insights`**
    *   描述: 获取指定联系人的最新关系洞察 (通常在查看联系人详情时聚合返回，此端点可用于刷新或单独获取)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "data": { "insights": { "intimacy_score": 85.5, ... } } }`
*   **`POST /api/v1/contacts/{contact_id}/insights/refresh`** (可选)
    *   描述: 请求重新计算并刷新指定联系人的关系洞察 (可能是耗时操作，可异步处理)。
    *   请求头: `Authorization: Bearer <jwt_token>`

### 13. 礼物管理 (Gifts)

*   **`POST /api/v1/gifts`**
    *   描述: 记录一个新的礼物 (送出或收到)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "contact_id": 123, "direction": "sent", "gift_name": "钢笔", "gift_date": "YYYY-MM-DD", "occasion": "生日", "value_estimate_json": {"amount": 300, "currency": "CNY"} }`
*   **`GET /api/v1/gifts`**
    *   描述: 获取用户的礼物记录列表 (支持按联系人、方向、日期等筛选)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?contact_id=123&direction=received&year=2023`
*   **`PUT /api/v1/gifts/{gift_id}`**
    *   描述: 更新指定礼物记录。
    *   请求头: `Authorization: Bearer <jwt_token>`
*   **`DELETE /api/v1/gifts/{gift_id}`**
    *   描述: 删除指定礼物记录。
    *   请求头: `Authorization: Bearer <jwt_token>`

### 14. 人脉相关AI辅助 (AI Assist for Contacts)

*   **`POST /api/v1/ai/assist/contact-profiling`**
    *   描述: 从文本中提取联系人信息用于档案创建辅助。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "text_to_analyze": "昨天和李明一起吃饭，他提到他生日是5月10号，喜欢打篮球，不吃辣。", "model_id": "optional_model_to_use" }`
    *   响应体 (成功): `{ "success": true, "data": { "extracted_info": { "name": "李明", "birth_date": "MM-DD", "interests": ["打篮球"], "preferences": ["不吃辣"] } } }`
*   **`POST /api/v1/ai/assist/relationship-suggestion`**
    *   描述: 请求AI提供关系维护建议或情商辅助。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "contact_id": 123 (可选), "situation_description": "最近和朋友小王有些疏远，想知道如何改善。", "suggestion_type": "communication_tips" / "activity_ideas", "model_id": "optional_model_to_use" }`
    *   响应体 (成功): `{ "success": true, "data": { "suggestion": "AI生成的建议文本..." } }`

## 三、关键交互流程示例

1.  **用户登录:**
    *   前端: 用户提交邮箱和密码。
    *   前端 -> 后端: `POST /api/v1/auth/login` 带凭据。
    *   后端: 验证凭据，生成JWT。
    *   后端 -> 前端: 返回用户信息和JWT。
    *   前端: 存储JWT，导航到主页。

2.  **创建日记 (带AI辅助):**
    *   前端: 用户打开新日记页面，输入标题和部分内容。
    *   前端: 用户点击"AI补全句子"按钮。
    *   前端 -> 后端: `POST /api/v1/ai/assist/writing` 带当前文本、任务类型、所选AI模型ID。
    *   后端: 获取用户AI配置 (API Key等)，调用第三方AI模型API。
    *   第三方AI -> 后端: 返回建议文本。
    *   后端 -> 前端: 返回AI建议。
    *   前端: 显示建议，用户采纳或修改。
    *   前端: 用户完成编辑，点击保存。
    *   前端 -> 后端: `POST /api/v1/diaries` 带完整日记数据 (包括AI润色后的内容)。
    *   后端: 保存日记到数据库。
    *   后端 -> 前端: 返回成功和新日记数据。

3.  **AI对话记录日记:**
    *   前端: 用户进入AI对话界面，发送消息："帮我记录今天的日记"。
    *   前端 -> 后端: `POST /api/v1/ai/chat` 带消息历史和用户当前消息。
    *   后端: 调用第三方AI模型API进行对话处理。
    *   第三方AI -> 后端: 返回AI的回复 (例如："好的，今天发生了什么特别的事情吗？")。
    *   后端 -> 前端: 返回AI回复。
    *   前端: 显示AI回复，用户继续对话，逐步提供日记内容。
    *   (对话结束) 前端: 用户确认保存，将整理好的对话内容作为日记正文。
    *   前端 -> 后端: `POST /api/v1/diaries` 带日记数据。

4.  **切换AI模型:**
    *   前端: 用户在设置中选择新的AI模型，如果需要，输入该模型的API Key。
    *   前端 -> 后端: `PUT /api/v1/users/me/ai-config` 带选择的模型ID和API Key (如有)。
    *   后端: 验证并加密存储API Key，更新用户偏好模型。
    *   后端 -> 前端: 返回成功消息。
    *   前端: 后续AI请求将使用新配置。

5.  **创建联系人 (AI辅助):**
    *   前端: 用户进入添加联系人页面，选择"从文本智能识别"或粘贴一段描述性文字。
    *   前端 -> 后端: `POST /api/v1/ai/assist/contact-profiling` 带待分析文本。
    *   后端: 调用AI模型提取信息。
    *   后端 -> 前端: 返回提取的结构化信息 (姓名、生日、兴趣等)。
    *   前端: 将AI提取的信息预填充到联系人表单中，用户可编辑确认。
    *   前端 -> 后端: `POST /api/v1/contacts` 带完整的联系人数据。
    *   后端: 保存联系人到数据库。
    *   后端 -> 前端: 返回成功和新联系人数据。

6.  **查看人物详情并获取AI建议:**
    *   前端: 用户点击某联系人，进入其详情页。
    *   前端 -> 后端: `GET /api/v1/contacts/{contact_id}`。
    *   后端: 从数据库聚合联系人档案、近期互动、提醒、最新洞察等。
    *   后端 -> 前端: 返回聚合的联系人详情数据。
    *   前端: 展示联系人信息，包括AI生成的亲密度、印象词云。
    *   前端: 用户点击"获取关系建议"按钮。
    *   前端 -> 后端: `POST /api/v1/ai/assist/relationship-suggestion` 带联系人ID和情境。
    *   后端: 基于联系人数据和情境，调用AI模型生成建议。
    *   后端 -> 前端: 返回AI建议。
    *   前端: 显示建议给用户。

7.  **处理智能提醒:**
    *   (创建时) 前端: 用户为联系人设置生日提醒。
    *   前端 -> 后端: `POST /api/v1/contacts/{contact_id}/reminders`。
    *   后端: 保存提醒到数据库。
    *   (触发时) 后端定时任务: 检查到期提醒。
    *   后端 -> 推送服务: 发送提醒通知。
    *   推送服务 -> 客户端: 用户收到通知。
    *   前端: 用户点击通知，应用打开并导航到相关联系人页面。





# AI日记App前后端交互与API设计

本文档旨在详细说明AI日记App中前端与后端之间的交互方式，并定义主要的API接口设计。这将基于先前文档中确定的功能需求、系统架构、数据流和UI设计。

## 一、API设计原则

1.  **RESTful架构:** API将遵循REST原则，使用标准的HTTP方法 (GET, POST, PUT, DELETE) 和状态码。
2.  **JSON数据格式:** 所有请求体和响应体都将使用JSON格式。
3.  **身份认证:** 所有需要用户身份验证的API端点将使用JWT (JSON Web Tokens) 进行保护。Token将在登录后发放，并通过Authorization HTTP头部 (Bearer Token) 在后续请求中传递。
4.  **版本控制:** API将进行版本控制 (例如: `/api/v1/...`)，以便未来的迭代和兼容性。
5.  **一致的响应结构:** 所有API响应将遵循一致的结构，例如:
    ```json
    {
      "success": true, // boolean
      "data": { ... }, // 结果数据，成功时存在
      "message": "Operation successful", // 消息文本，可选
      "error": null // 错误对象，失败时存在
    }
    // 失败时:
    {
      "success": false,
      "data": null,
      "message": "An error occurred",
      "error": {
        "code": "ERROR_CODE",
        "details": "Specific error details..."
      }
    }
    ```
6.  **错误处理:** 使用标准的HTTP状态码来指示请求结果 (例如: 200 OK, 201 Created, 400 Bad Request, 401 Unauthorized, 403 Forbidden, 404 Not Found, 500 Internal Server Error)。

## 二、API端点设计

以下是主要功能模块的API端点定义：

### 1. 认证 (Auth)

*   **`POST /api/v1/auth/register`**
    *   描述: 用户注册。
    *   请求体: `{ "email": "user@example.com", "password": "securepassword123", "nickname": "JohnDoe" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... }, "token": "jwt_token" } }`
*   **`POST /api/v1/auth/login`**
    *   描述: 用户登录。
    *   请求体: `{ "email": "user@example.com", "password": "securepassword123" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... }, "token": "jwt_token" } }`
*   **`POST /api/v1/auth/logout`**
    *   描述: 用户登出 (后端可将token加入黑名单)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "message": "Logged out successfully" }`
*   **`POST /api/v1/auth/refresh-token`**
    *   描述: 刷新JWT。
    *   请求体: `{ "refreshToken": "refresh_token_value" }`
    *   响应体 (成功): `{ "success": true, "data": { "token": "new_jwt_token" } }`
*   **`POST /api/v1/auth/forgot-password`**
    *   描述: 请求密码重置邮件。
    *   请求体: `{ "email": "user@example.com" }`
*   **`POST /api/v1/auth/reset-password`**
    *   描述: 使用重置令牌设置新密码。
    *   请求体: `{ "resetToken": "some_token", "newPassword": "newSecurePassword" }`

### 2. 用户 (Users)

*   **`GET /api/v1/users/me`**
    *   描述: 获取当前登录用户信息。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   响应体 (成功): `{ "success": true, "data": { "user_id": 1, "email": "...", "nickname": "...", "avatar_url": "..." } }`
*   **`PUT /api/v1/users/me`**
    *   描述: 更新当前登录用户信息 (例如昵称、头像)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "nickname": "NewNickname", "avatar_url": "new_url" }`
    *   响应体 (成功): `{ "success": true, "data": { "user": { ... } } }`

### 3. 日记 (Diaries)

*   **`POST /api/v1/diaries`**
    *   描述: 创建新日记条目。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   请求体: `{ "title": "My Day", "content_text": "...", "content_html": "<p>...</p>", "mood": "Happy", "entry_date": "YYYY-MM-DD", "tags": ["work", "project"], "attachments": [{"file_url": "...", "file_type": "image/jpeg"}] }`
    *   响应体 (成功): `{ "success": true, "data": { "diary": { ... } } }`
*   **`GET /api/v1/diaries`**
    *   描述: 获取用户日记列表 (支持分页、筛选、排序)。
    *   请求头: `Authorization: Bearer <jwt_token>`
    *   查询参数: `?page=1&limit=10&sort_by=entry_date&order=desc&mood=Happy&tag=work&date_from=YYYY-MM-DD&date_to=YYYY-MM-DD`

